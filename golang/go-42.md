---
outline: deep
---

# Go 42 - [What's Concurrentcy?- How do you implement concurrency in Go ?]

Äáº§u tiÃªn trÆ°á»›c khi Äi vÃ o Concurrentcy chÃºng ta sáº½ tÃ¬m hiá»ƒu 2 KhÃ¡i niá»‡m vá» **Concurrency** VÃ  **Parallelism**

Máº·c dÃ¹ Concurrency vÃ  parallelism thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ thay tháº¿ cho nhau , nhÆ°ng Ã½ nghÄ©a lÃ  hoÃ n toÃ n khÃ¡c nhau:

- Concurrency (TÃ­nh Ä‘á»“ng thá»i): LÃ  kháº£ nÄƒng thá»±c nhiá»u nhiá»u tÃ¡c vá»¥ (task) cÃ¹ng má»™t lÃºc, **nhÆ°ng khÃ´ng nháº¥t thiáº¿t pháº£i cháº¡y song song trÃªn cÃ¡c Core cá»§a CPU khÃ¡c nhau**. CÃ¡c task cÃ³ thá»ƒ sá»­ dá»¥ng luÃ¢n phiÃªn nhau sá»­ dá»¥ng tÃ i nguyÃªn CPU, nhá» vÃ o cÆ¡ cháº¿ **context switch**
>**Hiá»ƒu nÃ´m na lÃ  : ChÆ°Æ¡ng trÃ¬nh Ä‘a luá»“ng cháº¡y trÃªn 1 core cá»§a CPU vÃ  luÃ¢n phiÃªn thá»±c thi task**
- Parallelism (TÃ­nh song song) : LÃ  kháº£ nÄƒng chia 1 Task lá»›n thÃ nh nhiá»u task nhá» hÆ¡n (sub-task) vÃ  cháº¡y Ä‘á»“ng thá»i trÃªn nhiá»u core cá»§a CPU Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ xá»­ lÃ½.
> **Hiá»ƒu nÃ´m na lÃ  : ChÆ°á»ng trÃ¬nh Ä‘a luá»“ng cháº¡y trÃªn nhiá»u core cá»§a CPU vÃ  thá»±c thi tÃ¡c vá»¥ cÃ¹ng lÃºc**

## Váº­y nÃªn lÃ m cÃ¡ch nÃ o Ä‘á»ƒ triá»ƒn khai concurrency trong GO

Go cung cáº¥p 1 model concurrency Ä‘Æ¡n giáº£n vÃ  máº¡nh máº½ thÃ´ng qua **Goroutine** vÃ  **Channels**.

### Goroutine

Goroutine lÃ  cÃ¡c **lightweight thread** Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi runtime cá»§a Go, cho phÃ©p thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ Ä‘á»“ng thá»i hiá»‡u quáº£ vÃ  dá»… dÃ ng.

Táº¡i sao láº¡i nÃ³i lÃ  **Lightweight thread** ?

- Goroutines Ä‘Æ°á»£c báº¯t Ä‘áº§u báº±ng 1 **stack**, ráº¥t nhá» chá»‰ khoáº£ng **2 KB** . Stack sáº½ tá»± Ä‘á»™ng má»Ÿ rá»™ng khi cáº§n, cÃ³ thá»ƒ lÃªn 1 GB. Äiá»u nÃ y giÃºp giáº£m Ä‘Ã¡ng ká»ƒ chi phÃ­ bá»™ nhá»› khi táº¡o nhiá»u Goroutines.

- **Tháº¿ Vá»›i Thread trong Java thÃ¬ sao**? : Má»—i thread trong **Java** Ä‘Æ°á»£c táº¡o báº±ng 1 stack cá»‘ Ä‘á»‹nh vá»›i kÃ­ch thÆ°á»›c lá»›n hÆ¡n nhiá»u thÆ°á»ng sáº½ khoáº£ng 512KB > 1MB tuá»³ thuá»™c vÃ o JVM. Cho nÃªn lÃ m lÃ£ng phÃ­ bá»™ nhá»› náº¿u táº¡o nhiá»u threads


- Goroutines Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi Go runtime 1 cÃ¡ch Ä‘á»™c láº­p vÃ  khÃ´ng phá»¥ thuá»™c vÃ o OS.
- Runtime cá»§a Go sá»­ dá»¥ng má»™t bá»™ **scheduler** Ä‘á»ƒ Ã¡nh xáº¡ hÃ ng ngÃ n Goroutines lÃªn má»™t sá»‘ Ã­t **OS threads**. Scheduler thá»±c hiá»‡n viá»‡c chuyá»ƒn Ä‘á»•i ngá»¯ cáº£nh (**context switching**) giá»¯a cÃ¡c Goroutines ráº¥t nhanh, vÃ¬ nÃ³ xáº£y ra á»Ÿ má»©c á»©ng dá»¥ng.

- **Äá»‘i vá»›i Java lÃ  OS threads.** Viá»‡c quáº£n lÃ½ phá»¥ thuá»™c vÃ  OS bao gá»“m cáº£ viá»‡c cáº¥p phÃ¡t tÃ i nguyÃªn vÃ  **context switching.**
- Viá»‡c chuyá»ƒn Ä‘á»•i ngá»¯ cáº£nh giá»¯a cÃ¡c OS threads tá»‘n kÃ©m hÆ¡n vÃ¬ nÃ³ yÃªu cáº§u tÆ°Æ¡ng tÃ¡c vá»›i kernel cá»§a há»‡ Ä‘iá»u hÃ nh.



| **TiÃªu chÃ­**               | **Goroutines (Go)**                            | **Threads (Java)**                                   |
|----------------------------|-----------------------------------------------|----------------------------------------------------|
| **KÃ­ch thÆ°á»›c stack ban Ä‘áº§u** | ~2KB                                          | ~512KB Ä‘áº¿n 1MB                                     |
| **Quáº£n lÃ½ bá»Ÿi**             | Go runtime (scheduler á»Ÿ má»©c á»©ng dá»¥ng).        | Kernel cá»§a há»‡ Ä‘iá»u hÃ nh (OS-level threads).       |
| **Chi phÃ­ context switching** | Tháº¥p (do runtime quáº£n lÃ½ vÃ  tá»‘i Æ°u).          | Cao (do phá»¥ thuá»™c kernel vÃ  OS).                  |
| **Sá»‘ lÆ°á»£ng há»— trá»£ tá»‘i Ä‘a**   | HÃ ng triá»‡u Goroutines trÃªn má»™t há»‡ thá»‘ng.      | HÃ ng ngÃ n threads trÆ°á»›c khi cáº¡n kiá»‡t tÃ i nguyÃªn.  |
| **Giao tiáº¿p giá»¯a cÃ¡c threads** | Sá»­ dá»¥ng **channels** (tÃ­ch há»£p trong ngÃ´n ngá»¯).| Sá»­ dá»¥ng cÃ¡c cÃ´ng cá»¥ nhÆ° **synchronized**, **Locks**, hoáº·c **Executors**. |
| **Äá»“ng bá»™ hÃ³a**              | Channels cung cáº¥p cÆ¡ cháº¿ Ä‘á»“ng bá»™ hÃ³a an toÃ n.| YÃªu cáº§u sá»­ dá»¥ng khÃ³a hoáº·c cÆ¡ cháº¿ Ä‘á»“ng bá»™ riÃªng.    |


### Sá»­ dá»¥ng Goroutine

```go

    func main() {
        fmt.Println("Starting....")
        ids := []int{1,2,3,4,5}

        start := time.Now()

        for _,id :=range ids {
            go getProductByIdAPI(id)
        }

        fmt.Println("Finished...",time.Since(start))
    }

    func getProductByIdAPI(id int){
        fmt.Println(">>> Data ProductId:",id)
        time.Sleep(time.Second * 1)
    }
```

```
Starting ...
Finished .... ???time
```

Äiá»u gÃ¬ xáº£y ra á»Ÿ Ä‘Ã¢y ?

- Khi báº¡n gá»i ```go getProductByIdAPI``` má»™t goroutine má»›i Ä‘Æ°á»£c táº¡o Ä‘á»ƒ thá»±c thi hÃ m ```getProductByIdAPI```.

- HÃ m ```main``` vÃ  Goroutine má»›i sáº½ cháº¡y Ä‘á»“ng thá»i.

- VÃ¬ Goroutine khÃ´ng Ä‘á»“ng bá»™ hoÃ¡ máº·c Ä‘á»‹nh, ```main``` cÃ³ thá»ƒ káº¿t thÃºc trÆ°á»›c khi ```getProductByIdAPI``` hoÃ n táº¥t, dáº«n Ä‘áº¿n viá»‡c khÃ´ng tháº¥y káº¿t quáº£ tá»« Goroutines.

- Báº£n thÃ¢n ```main``` cÅ©ng lÃ  1 Goroutine (**Máº¡nh nháº¥t**) há»‡ sinh thÃ¡i nÃ y. Má»™t khi nÃ³ káº¿t thÃºc thÃ¬ toÃ n bá»™ Goroutine cÅ©ng sáº½ káº¿t thÃºc.

Váº­y nÃªn sáº½ cÃ³ cÃ¡c giáº£i phÃ¡p Ä‘á»ƒ giáº£i quyáº¿t.

1. **KhÃ´ng Ä‘á»“ng bá»™ hoÃ¡** :

- **Goroutines** khÃ´ng Ä‘á»“ng bá»™ hÃ³a vá»›i nhau hoáº·c vá»›i hÃ m main. Do Ä‘Ã³, náº¿u main káº¿t thÃºc trÆ°á»›c, cÃ¡c Goroutines cÅ©ng sáº½ bá»‹ dá»«ng.

ğŸ‘‰ **Giáº£i phÃ¡p**: Sá»­ dá»¥ng cÆ¡ cháº¿ Ä‘á»“ng bá»™ hÃ³a nhÆ° ```WaitGroup``` hoáº·c ```Channels```.

2. **Lá»—i Race Condition** :

- Náº¿u nhiá»u Goroutines truy cáº­p vÃ  thay Ä‘á»•i má»™t tÃ i nguyÃªn chung cÃ¹ng lÃºc, cÃ³ thá»ƒ xáº£y ra lá»—i **race condition**.

ğŸ‘‰ **Giáº£i phÃ¡p**: Sá»­ dá»¥ng cÆ¡ cháº¿ khÃ³a (```mutex```) hoáº·c ```channel``` Ä‘á»ƒ Ä‘á»“ng bá»™ hÃ³a.

3. Quáº£n lÃ½ quÃ¡ nhiá»u Goroutines

- **Táº¡o quÃ¡ nhiá»u Goroutines (hÃ ng triá»‡u)** cÃ³ thá»ƒ gÃ¢y ra tÃ¬nh tráº¡ng cáº¡n kiá»‡t tÃ i nguyÃªn há»‡ thá»‘ng.

ğŸ‘‰ **Giáº£i phÃ¡p**: Sá»­ dá»¥ng cÃ¡c ká»¹ thuáº­t nhÆ° **worker pool** Ä‘á»ƒ giá»›i háº¡n sá»‘ lÆ°á»£ng Goroutines cháº¡y cÃ¹ng lÃºc.

Sá»­ dá»¥ng wait Group

```go

    func main() {
        var wg sync.WaitGroup // Táº¡o 1 wait Group

        fmt.Println("Starting....")
        ids := []int{1,2,3,4,5}

        start := time.Now()

        for _,id :=range ids {
            wg.Add(1) // Má»—i Loop add vao waitgroup

            go getProductByIdAPI(id,&wg)
        }
        wg.Wait() 
        fmt.Println("Finished...",time.Since(start))
    }

    func getProductByIdAPI(id int, wg *sync.WaitGroup){
        defer wg.Done() // Done hoÃ n thÃ nh 1 goroutine
        fmt.Println(">>> Data ProductId:",id)
        time.Sleep(time.Second * 1)
    }
```

- CÃ³ thá»ƒ vÃ­ Defer nhÆ° Finally trong Try Catch.

> **Cho dÃ¹ ta yÃªu nhau sai hay Ä‘Ãºng. CÃ²n tháº¥y Ä‘au lÃ  cÃ²n thÆ°Æ¡ng.**

- DÃ¹ sai hay Ä‘Ãºng thÃ¬ cÅ©ng pháº£i xuáº¥t hiá»‡n trong Finally nhÆ° trong Java hay Nodejs. ThÃ¬ Defer cÅ©ng nhÆ° váº­y ```wg.Done()```


...

Xem video FULL Ä‘á»ƒ hiá»ƒu rÃµ hÆ¡n táº¡i: [GO 42: Äáº¿n lÃºc Ä‘áº¿n pháº§n láº­p trÃ¬nh Ä‘á»“ng thá»i trong GO - Goroutine Concurrency in golang](https://youtu.be/PLdLSF0_QQY)
